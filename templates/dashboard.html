<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
    .card-title { font-weight: bold; }
    .wallet-card, .crypto-card { border-radius: 1rem; }
    .balance, .earnings { font-size: 1.5rem; font-weight: 600; }
    .balance { color: #198754; background: linear-gradient(90deg, #e0ffe0 0%, #f8fff8 100%); border-radius: 0.5rem; padding: 0.25em 0.75em; display: inline-block; }
    .earnings { color: #0d6efd; background: linear-gradient(90deg, #e0f0ff 0%, #f8fbff 100%); border-radius: 0.5rem; padding: 0.25em 0.75em; display: inline-block; transition: background 0.5s; }
    .wallet-id { font-size: 0.9rem; word-break: break-all; cursor: pointer; }
    .wallet-id.copied { background: #d1e7dd; color: #198754; transition: background 0.5s, color 0.5s; }
    /* Earnings highlight animation */
    .earnings-update { animation: highlight 1s ease-in-out; }
    @keyframes highlight { 0% { background-color: #ffff99; } 100% { background-color: transparent; } }

    @media (max-width: 768px) {
      .wallet-card, .crypto-card { margin-bottom: 1.5rem; }
      .navbar .container-fluid { flex-direction: column; align-items: flex-start; }
      .navbar .d-flex { flex-direction: column; width: 100%; }
      .navbar .navbar-text, .navbar .btn { margin-bottom: 0.5rem; }
      .navbar .navbar-text { font-size: 1rem; }
      .balance, .earnings { font-size: 1.1rem; }
      .container { padding: 0 0.5rem; }
    }
    @media (max-width: 576px) {
        .navbar .navbar-text { display: block; margin-bottom: 0.5rem; }
        .navbar .btn { width: 100%; margin-bottom: 0.5rem; }
        .wallet-card, .crypto-card { padding: 1rem 0.5rem; }
    }

    /* Dark/Light mode */
    body.dark-mode { background: #181a1b; color: #f8f9fa; }
    body.dark-mode .card { background: #23272b; color: #f8f9fa; }
    body.dark-mode .navbar { background: #23272b !important; }
    body.dark-mode .table { color: #f8f9fa; }
    body.dark-mode .btn-outline-light { color: #f8f9fa; border-color: #f8f9fa; }
    body.dark-mode .balance { background: #223322; color: #7fff7f; }
    body.dark-mode .earnings { background: #223355; color: #7faaff; }

    body.light-mode { background: #f8f9fa; color: #222; }
    body.light-mode .navbar { background: #fff !important; color: #222; }
    body.light-mode .card { background: #fff; color: #222; }
    body.light-mode .btn-outline-light { color: #222; border-color: #ccc; }
    body.light-mode .btn-outline-light:hover { background: #e2e6ea; }

    #profile-image-upload { max-width:180px; }

    /* Modern Crypto Card Styles */
    .crypto-list-section { margin-top: 2rem; }
    .crypto-card-modern {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      margin-bottom: 1.2rem;
      padding: 1rem 1.2rem;
      transition: background 0.3s;
    }
    body.dark-mode .crypto-card-modern {
      background: #23272b;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    }
    .crypto-symbol { font-size: 1.2rem; font-weight: 700; min-width: 60px; text-align: left; }
    .crypto-trend { flex: 1; min-width: 100px; max-width: 160px; margin: 0 1rem; }
    .crypto-price { font-size: 1.1rem; font-weight: 600; text-align: right; }
    .crypto-change { font-size: 1rem; font-weight: 500; margin-left: 0.5rem; text-align: right; }
    .crypto-change.positive { color: #198754; }
    .crypto-change.negative { color: #dc3545; }
    .crypto-card-modern:not(:last-child) { margin-bottom: 1.2rem; }
    @media (max-width: 768px) {
      .crypto-card-modern { flex-direction: column; align-items: stretch; padding: 1rem 0.5rem; }
      .crypto-symbol, .crypto-price, .crypto-change { text-align: left; }
      .crypto-trend { margin: 0.5rem 0; }
    }

    #darkModeToggleContainer {
      position: fixed;
      top: 1.5rem;
      right: 2rem;
      z-index: 1050;
    }
    @media (max-width: 768px) {
      #darkModeToggleContainer { position: absolute; top: 0.5rem; right: 0.5rem; }
    }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">CryptoDash</a>
    <div class="d-flex">
      <span class="navbar-text text-white me-3">
        Hello, {{ profile.user.username }}
      </span>
      <a href="/accounts/password_change/" class="btn btn-outline-light me-2" title="Change Password">
        <i class="bi bi-gear-fill"></i>
      </a>
      <form method="post" action="{% url 'logout' %}" class="d-inline">
        {% csrf_token %}
        <button class="btn btn-outline-light" type="submit">Logout</button>
      </form>
    </div>
  </div>
</nav>

<!-- Dark mode toggle -->
<div class="form-check form-switch" id="darkModeToggleContainer">
  <input class="form-check-input" type="checkbox" id="darkModeSwitch" onclick="toggleDarkMode()">
  <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
</div>

<!-- Main Content -->
<div class="container mt-5">
  <div class="row">

    <!-- Wallet Info Card -->
    <div class="col-md-4 mb-4">
      <div class="card wallet-card shadow-sm p-3">
        <h5 class="card-title">Wallet Info</h5>
        <div class="text-center mb-3">
          {% if profile.image %}
            <img src="{{ profile.image.url }}" alt="Profile Picture" class="rounded-circle" width="80" height="80">
          {% else %}
            <img src="/static/default-profile.png" alt="Profile Picture" class="rounded-circle" width="80" height="80">
          {% endif %}
          <form method="post" enctype="multipart/form-data" action="/profile/upload/" class="mt-2">
            {% csrf_token %}
            <label for="profile-image-upload" class="visually-hidden">Profile Image</label>
            <input id="profile-image-upload" type="file" name="image" accept="image/*" class="form-control form-control-sm d-inline-block w-auto" placeholder="Choose image" title="Choose image">
            <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
          </form>
        </div>
        <p class="wallet-id" id="wallet-id" onclick="copyWallet()" title="Copy Wallet ID">{{ profile.wallet_id }}</p>
        <button class="btn btn-sm btn-outline-primary mb-2" id="copy-btn" onclick="copyWallet()">
          <i class="bi bi-clipboard"></i> Copy Wallet
        </button>

        <h5 class="card-title mt-3">Balance</h5>
        <p class="balance" id="balance">${{ profile.balance }}</p>

        <h5 class="card-title">Earnings</h5>
        <p class="earnings" id="earnings">${{ profile.earnings }}</p>
      </div>
    </div>

    <!-- Crypto Prices Card (modern vertical stack) -->
    <div class="col-md-8 mb-4">
      <div class="crypto-list-section">
        <h5 class="mb-3">Live Crypto Prices</h5>
        <div id="crypto-list"></div>
      </div>
    </div>

  </div>

  <!-- Transaction History Section -->
  <div class="table-responsive mt-4">
    <h5>Transaction History</h5>
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>Coin</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in transactions %}
        <tr>
          <td>{{ tx.created_at|date:'Y-m-d H:i' }}</td>
          <td>{{ tx.get_tx_type_display }}</td>
          <td>{{ tx.coin|title }}</td>
          <td>{{ tx.amount }} {{ tx.coin|upper }}</td>
          <td><span class="badge {% if tx.status == 'Completed' %}bg-success{% else %}bg-warning text-dark{% endif %}">{{ tx.status }}</span></td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center">No transactions yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Bootstrap JS & Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Run after page loads to avoid DOM issues
document.addEventListener("DOMContentLoaded", function () {

  // =============================
  // Copy Wallet Helper
  // =============================
  function copyWallet() {
    const wallet = document.getElementById('wallet-id');
    const copyBtn = document.getElementById('copy-btn');

    navigator.clipboard.writeText(wallet.innerText).then(() => {
      wallet.classList.add('copied');
      copyBtn.innerHTML = '<i class="bi bi-clipboard-check"></i> Wallet ID Copied!';
      setTimeout(() => {
        wallet.classList.remove('copied');
        copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy Wallet';
      }, 1500);
    });
  }
  window.copyWallet = copyWallet;


  // =============================
  // Bootstrap Tooltips
  // =============================
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el));


  // =============================
  // ðŸŒ™ Dark Mode Toggle
  // =============================
  const themeToggleBtn = document.getElementById('theme-toggle');

  function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  // Load saved theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
  }

  if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', toggleTheme);
  }


  // =============================
  // Crypto Card Setup
  // =============================
  const coins = [
    { id: 'bitcoin', symbol: 'BTC' },
    { id: 'ethereum', symbol: 'ETH' },
    { id: 'solana', symbol: 'SOL' },
    { id: 'cardano', symbol: 'ADA' },
    { id: 'dogecoin', symbol: 'DOGE' }
  ];

  const cryptoList = document.getElementById('crypto-list');
  let charts = {};

  function createCryptoCard(symbol) {
    const card = document.createElement('div');
    card.className = 'crypto-card-modern';
    card.innerHTML = `
      <div class="crypto-symbol">${symbol}</div>
      <div class="crypto-trend">
        <canvas id="trend-${symbol}" height="32" width="140"></canvas>
      </div>
      <div class="crypto-price" id="price-${symbol}">$--.--</div>
      <div class="crypto-change" id="change-${symbol}">--%</div>
    `;
    return card;
  }

  function renderCryptoCards() {
    cryptoList.innerHTML = '';
    coins.forEach(coin => {
      cryptoList.appendChild(createCryptoCard(coin.symbol));
    });
  }

  renderCryptoCards();


  // =============================
  // Update Crypto Card
  // =============================
  function updateCryptoCard(symbol, price, change, history) {
    const priceEl = document.getElementById(`price-${symbol}`);
    const changeEl = document.getElementById(`change-${symbol}`);

    if (price !== null && !Number.isNaN(price)) {
      priceEl.textContent = `$${price.toFixed(2)}`;
    }

    if (change !== null && !Number.isNaN(change)) {
      const sign = change >= 0 ? '+' : '';
      changeEl.textContent = `${sign}${change.toFixed(2)}%`;
      changeEl.className = 'crypto-change ' + (change >= 0 ? 'positive' : 'negative');
    }

    const canvas = document.getElementById(`trend-${symbol}`);
    if (!canvas || !history || history.length < 2) return;

    const ctx = canvas.getContext('2d');

    if (charts[symbol]) {
      charts[symbol].destroy();
    }

    charts[symbol] = new Chart(ctx, {
      type: 'line',
      data: {
        labels: history.map((_, i) => i),
        datasets: [{
          data: history.slice(-24),
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.08)',
          fill: true,
          tension: 0.4,
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: false,
        plugins: { legend: { display: false } },
        scales: { x: { display: false }, y: { display: false } },
        animation: false
      }
    });
  }


  // =============================
  // Fetch Prices & History
  // =============================
  async function updateAllCryptoCards() {
    try {
      const res = await fetch('/api/crypto/prices');
      if (!res.ok) throw new Error(res.status);
      const prices = await res.json();

      for (const coin of coins) {

        const histRes = await fetch(`/api/crypto/history?id=${coin.id}`);
        if (!histRes.ok) continue;

        const histData = await histRes.json();

        const history = Array.isArray(histData?.prices)
          ? histData.prices.map(p => p[1])
          : [];

        const price = prices?.[coin.id]?.usd ?? null;

        updateCryptoCard(coin.symbol, price, null, history);
      }

    } catch (err) {
      console.error("Crypto update failed:", err);
    }
  }


  // =============================
  // Start Updates
  // =============================
  updateAllCryptoCards();
  setInterval(updateAllCryptoCards, 60000);

});


</script>

<script>
function toggleDarkMode() {
  const body = document.body;
  const isDark = body.classList.toggle('dark-mode');

  // remove light mode if dark is on
  if (isDark) {
    body.classList.remove('light-mode');
  } else {
    body.classList.add('light-mode');
  }

  localStorage.setItem('darkMode', isDark);
}

// Load saved mode on page load
document.addEventListener("DOMContentLoaded", function () {
  const savedDark = localStorage.getItem('darkMode') === 'true';
  const switchEl = document.getElementById('darkModeSwitch');

  if (savedDark) {
    document.body.classList.add('dark-mode');
    if (switchEl) switchEl.checked = true;
  } else {
    document.body.classList.add('light-mode');
  }
});
</script>


</body>
</html>

